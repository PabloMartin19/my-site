---
title: "Configuración/activación de SELinux"
date: 2025-01-29 19:00:00 +0000
categories: [Sistemas, SELinux]
tags: [SELinux]
author: pablo
description: "...."
toc: true
comments: true
image:
  path: /assets/img/SeLinux-Configuracion-MAC.jpeg
---

Hoy nos adentramos en la configuración de un servidor basado en Rocky Linux con SELinux activado en modo enforcing. Nuestro objetivo es asegurar que los servicios **SSHFS**, **Samba** y **NFS** funcionen correctamente bajo una configuración estricta y segura de SELinux. Además, habilitaremos el inicio de sesión remoto como root y cambiaremos el puerto de acceso SSH por uno no habitual.

## Preparación del entorno

Antes de empezar, verificamos el estado de SELinux para asegurarnos de que está activado y en modo **enforcing**:

```bash
[rocky@rocky ~]$ sestatus 
SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
Loaded policy name:             targeted
Current mode:                   enforcing
Mode from config file:          enforcing
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Memory protection checking:     actual (secure)
Max kernel policy version:      33
```

Perfecto, SELinux está activado y en modo **enforcing**. Ahora actualizamos el sistema e instalamos los paquetes necesarios:

```bash
[rocky@rocky ~]$ sudo dnf update -y
[rocky@rocky ~]$ sudo dnf install samba samba-common samba-client nfs-utils -y
```

SSHFS


## SAMBA

Samba es un servicio crítico para compartir archivos en redes mixtas (Linux/Windows). Vamos a configurarlo paso a paso.

En primer lugar realizamos una copia de "seguridad" del archivo de configuración por si acaso necesitamos volver a ella:

```bash
[rocky@rocky ~]$ sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.backup
```

Creamos el directorio compartido con los permisos necesarios:

```bash
[rocky@rocky ~]$ sudo mkdir -p /mnt/samba/share
[rocky@rocky ~]$ sudo chmod -R 0755 /mnt/samba/share/
[rocky@rocky ~]$ sudo chown -R rocky:rocky /mnt/samba/share/
[rocky@rocky ~]$ sudo chcon -t samba_share_t /mnt/samba/share/
```

Aquí, `chcon` cambia el contexto de seguridad de SELinux para que el directorio sea accesible por Samba.

Editamos `/etc/samba/smb.conf` y añadimos la siguiente sección:

```
[Anonymous]
path = /mnt/samba/share
browsable = yes
writable = yes
guest ok = yes
read only = no
valid users = rocky
```

Y para realizar la comprobación de que la configuración es correcta ejecutamos el siguiente comando:

```bash
[rocky@rocky ~]$ testparm
Load smb config files from /etc/samba/smb.conf
Loaded services file OK.
Weak crypto is allowed by GnuTLS (e.g. NTLM as a compatibility fallback)

Server role: ROLE_STANDALONE

Press enter to see a dump of your service definitions

# Global parameters
[global]
	printcap name = cups
	security = USER
	workgroup = SAMBA
	idmap config * : backend = tdb
	cups options = raw


[homes]
	browseable = No
	comment = Home Directories
	inherit acls = Yes
	read only = No
	valid users = %S %D%w%S


[printers]
	browseable = No
	comment = All Printers
	create mask = 0600
	path = /var/tmp
	printable = Yes


[print$]
	comment = Printer Drivers
	create mask = 0664
	directory mask = 0775
	force group = @printadmin
	path = /var/lib/samba/drivers
	write list = @printadmin root


[Anonymous]
	guest ok = Yes
	path = /mnt/samba/share
	read only = No
	valid users = rocky
```


[rocky@rocky ~]$ sudo firewall-cmd --add-service=samba --zone=public --permanent
success
[rocky@rocky ~]$ sudo firewall-cmd --reload
success



[rocky@rocky ~]$ sudo systemctl start smb
[rocky@rocky ~]$ sudo systemctl enable smb
Created symlink /etc/systemd/system/multi-user.target.wants/smb.service → /usr/lib/systemd/system/smb.service.
[rocky@rocky ~]$ sudo systemctl start nmb
[rocky@rocky ~]$ sudo systemctl enable nmb
Created symlink /etc/systemd/system/multi-user.target.wants/nmb.service → /usr/lib/systemd/system/nmb.service.


[rocky@rocky ~]$ sudo smbpasswd -a rocky
New SMB password:
Retype new SMB password:
Added user rocky.




[rocky@cliente-rocky ~]$ sudo dnf install samba-client -y

[rocky@cliente-rocky ~]$ smbclient --user=rocky -L //10.0.0.175
Password for [SAMBA\rocky]:

	Sharename       Type      Comment
	---------       ----      -------
	print$          Disk      Printer Drivers
	Anonymous       Disk      
	IPC$            IPC       IPC Service (Samba 4.20.2)
	rocky           Disk      Home Directories
SMB1 disabled -- no workgroup available


[rocky@cliente-rocky ~]$ sudo mount -t cifs -o username=rocky,password=messi,rw,vers=2.1,file_mode=0777,dir_mode=0777 //10.0.0.175/Anonymous /home/rocky/montaje/
[rocky@cliente-rocky ~]$ df -h
Filesystem              Size  Used Avail Use% Mounted on
devtmpfs                4.0M     0  4.0M   0% /dev
tmpfs                   385M     0  385M   0% /dev/shm
tmpfs                   154M  532K  154M   1% /run
/dev/vda4               8.9G  1.1G  7.8G  13% /
/dev/vda3               936M  257M  680M  28% /boot
/dev/vda2               100M  7.0M   93M   8% /boot/efi
tmpfs                    77M     0   77M   0% /run/user/1000
10.0.0.175:/mnt/nfs/kk  8.9G  1.3G  7.7G  14% /mnt/nfs
//10.0.0.175/Anonymous  8.9G  1.3G  7.7G  14% /home/rocky/montaje











NFS

[rocky@rocky ~]$ sudo systemctl start nfs-server.service
[rocky@rocky ~]$ sudo systemctl enable nfs-server.service
Created symlink /etc/systemd/system/multi-user.target.wants/nfs-server.service → /usr/lib/systemd/system/nfs-server.service.


[rocky@rocky ~]$ sudo mkdir -p /mnt/nfs/kk


[rocky@rocky ~]$ sudo nano /etc/exports
[rocky@rocky ~]$ cat /etc/exports
/mnt/nfs/kk  10.0.0.0/24(rw,sync,no_all_squash,no_root_squash)


[rocky@rocky ~]$ sudo exportfs -arv
exporting 10.0.0.0/24:/mnt/nfs/kk


[rocky@rocky ~]$ sudo exportfs -s
/mnt/nfs/kk  10.0.0.0/24(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)


[rocky@rocky ~]$ sudo dnf install firewalld -y
[rocky@rocky ~]$ sudo systemctl start firewalld
[rocky@rocky ~]$ sudo systemctl enable firewalld
[rocky@rocky ~]$ sudo systemctl status firewalld
● firewalld.service - firewalld - dynamic firewall daemon
     Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; preset: enabled)
     Active: active (running) since Thu 2025-02-06 19:26:09 UTC; 6s ago
       Docs: man:firewalld(1)
   Main PID: 34890 (firewalld)
      Tasks: 2 (limit: 4450)
     Memory: 26.7M
        CPU: 471ms
     CGroup: /system.slice/firewalld.service
             └─34890 /usr/bin/python3 -s /usr/sbin/firewalld --nofork --nopid

Feb 06 19:26:09 rocky.novalocal systemd[1]: Starting firewalld - dynamic firewall daemon...
Feb 06 19:26:09 rocky.novalocal systemd[1]: Started firewalld - dynamic firewall daemon.


[rocky@rocky ~]$ sudo firewall-cmd --permanent --add-service=nfs
success
[rocky@rocky ~]$ sudo firewall-cmd --permanent --add-service=rpc-bind
success
[rocky@rocky ~]$ sudo firewall-cmd --permanent --add-service=mountd
success
[rocky@rocky ~]$ sudo firewall-cmd --reload
success





[rocky@cliente-rocky ~]$ sudo dnf install nfs-utils nfs4-acl-tools

[rocky@cliente-rocky ~]$ showmount -e 10.0.0.175
Export list for 10.0.0.175:
/mnt/nfs/kk 10.0.0.0/24



[rocky@rocky ~]$ echo 'Hola desde el servidor' | sudo tee /mnt/nfs/kk/hola.txt
Hola desde el servidor
[rocky@rocky ~]$ ls -l /mnt/nfs/kk/hola.txt 
-rw-r--r--. 1 root root 22 Feb  6 19:37 /mnt/nfs/kk/hola.txt



[rocky@cliente-rocky ~]$ ls -l /mnt/nfs/hola.txt 
-rw-r--r--. 1 root root 22 Feb  6 19:37 /mnt/nfs/hola.txt


[rocky@cliente-rocky ~]$ ls -l /mnt/nfs/hola.txt 
-rw-r--r--. 1 root root 22 Feb  6 19:37 /mnt/nfs/hola.txt
[rocky@cliente-rocky ~]$ df -h
Filesystem              Size  Used Avail Use% Mounted on
devtmpfs                4.0M     0  4.0M   0% /dev
tmpfs                   385M     0  385M   0% /dev/shm
tmpfs                   154M  532K  154M   1% /run
/dev/vda4               8.9G  1.1G  7.9G  12% /
/dev/vda3               936M  257M  680M  28% /boot
/dev/vda2               100M  7.0M   93M   8% /boot/efi
tmpfs                    77M     0   77M   0% /run/user/1000
10.0.0.175:/mnt/nfs/kk  8.9G  1.3G  7.7G  14% /mnt/nfs



[rocky@rocky ~]$ echo 'Hola desde el servidor' | sudo tee /mnt/samba/share/hola.txt
Hola desde el servidor

[rocky@cliente-rocky ~]$ ls -l montaje/
total 4
-rwxrwxrwx. 1 root root 23 Feb  6 20:16 hola.txt
[rocky@cliente-rocky ~]$ cat montaje/hola.txt 
Hola desde el servidor
